<div class="dialog-container">
  <div class="dialog-header">
    <div class="header-content">
      <h2 class="dialog-title">
        {{ esNuevo ? 'Agregar Lote' : 'Editar Lote' }}
      </h2>
      <p class="dialog-subtitle">
        {{ esNuevo ? 'Registra un nuevo lote en el inventario' : 'Modifica la
        información del lote seleccionado' }}
      </p>
    </div>
    <button mat-icon-button mat-dialog-close class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="dialog-content">
    <form [formGroup]="loteForm" class="form-container">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Insumo *</label>
          <select class="form-select" formControlName="id_insumo" required>
            <option value="">Seleccione un insumo</option>
            <option *ngFor="let insumo of insumos" [value]="insumo.id_insumo">
              {{ insumo.nombre }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Código de Lote *</label>
          <input
            class="form-input"
            formControlName="lote"
            placeholder="Ej: LT2024001"
            (input)="onLoteInput($event)"
            maxlength="100"
            required
          />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Ubicación</label>
          <input
            class="form-input"
            formControlName="ubicacion"
            placeholder="Ej: Almacén A - Estante 1"
            maxlength="200"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Estado *</label>
          <select class="form-select" formControlName="estado_lote" required>
            <option *ngFor="let estado of estadosLote" [value]="estado.valor">
              {{ estado.nombre }}
            </option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Stock Inicial *</label>
          <input
            class="form-input"
            type="number"
            formControlName="stock_inicial"
            placeholder="0"
            min="0"
            step="0.01"
            required
          />
        </div>

        <div class="form-group">
          <label class="form-label">Stock Actual *</label>
          <input
            class="form-input"
            type="number"
            formControlName="stock_actual"
            placeholder="0"
            min="0"
            step="0.01"
            (blur)="validarStockActual()"
            required
          />
        </div>
      </div>

      <!-- Indicador de porcentaje de stock -->
      <div
        class="stock-indicator"
        *ngIf="
          loteForm.get('stock_inicial')?.value &&
          loteForm.get('stock_actual')?.value
        "
      >
        <div class="stock-bar">
          <div
            class="stock-fill"
            [style.width.%]="calcularPorcentajeStock()"
            [class]="{
              'stock-critical': calcularPorcentajeStock() <= 10,
              'stock-low': calcularPorcentajeStock() <= 25 && calcularPorcentajeStock() > 10,
              'stock-medium': calcularPorcentajeStock() <= 50 && calcularPorcentajeStock() > 25,
              'stock-good': calcularPorcentajeStock() > 50
            }"
          ></div>
        </div>
        <span class="stock-percentage">{{ calcularPorcentajeStock() }}%</span>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Fecha de Expiración</label>
          <div class="date-input-container">
            <input
              class="form-input"
              [matDatepicker]="fechaPicker"
              formControlName="fecha_expiracion"
              placeholder="Seleccione una fecha"
            />
            <mat-datepicker-toggle
              class="date-picker-toggle"
              [for]="fechaPicker"
            ></mat-datepicker-toggle>
            <mat-datepicker #fechaPicker></mat-datepicker>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Precio Total</label>
          <input
            class="form-input"
            type="number"
            formControlName="precio_total"
            placeholder="0.00"
            min="0"
            step="0.01"
          />
        </div>
      </div>

      <!-- Información adicional -->
      <div class="info-section" *ngIf="!esNuevo">
        <h4>Información del lote</h4>
        <div class="info-grid">
          <div class="info-item">
            <label>ID del lote:</label>
            <span>{{ data.lote?.id_lote }}</span>
          </div>
          <div class="info-item">
            <label>Insumo actual:</label>
            <span>{{ getInsumoNombre(data.lote?.id_insumo || 0) }}</span>
          </div>
        </div>
      </div>
    </form>
  </div>

  <div class="dialog-actions">
    <button class="btn-cancel" (click)="cancelar()" [disabled]="cargando">
      Cancelar
    </button>
    <button
      class="btn-save"
      (click)="guardar()"
      [disabled]="loteForm.invalid || cargando"
    >
      {{ esNuevo ? 'Agregar Lote' : 'Guardar Cambios' }}
    </button>
  </div>
</div>
