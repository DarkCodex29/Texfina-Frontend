<div class="stock-container">
  <!-- Header de la página -->
  <div class="page-header">
    <h1 class="page-title">Consulta de Stock</h1>
    <div class="action-buttons">
      <button
        mat-raised-button
        color="primary"
        (click)="exportarExcel()"
        class="btn-exportar"
      >
        Exportar Excel
      </button>
    </div>
  </div>

  <!-- Cards de resumen -->
  <div class="summary-cards">
    <mat-card class="summary-card">
      <mat-card-content>
        <div class="card-content">
          <div class="card-value">{{ formatearNumero(totalItems) }}</div>
          <div class="card-label">Total de Items</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card">
      <mat-card-content>
        <div class="card-content">
          <div class="card-value">
            {{ formatearMoneda(valorTotalInventario) }}
          </div>
          <div class="card-label">Valor Total Inventario</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card warning">
      <mat-card-content>
        <div class="card-content">
          <div class="card-value">{{ formatearNumero(itemsCriticos) }}</div>
          <div class="card-label">Items Críticos</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card attention">
      <mat-card-content>
        <div class="card-content">
          <div class="card-value">{{ formatearNumero(itemsBajos) }}</div>
          <div class="card-label">Items con Stock Bajo</div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Filtros -->
  <mat-card class="filters-card">
    <mat-card-header>
      <mat-card-title>Filtros de Búsqueda</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="filtrosForm" class="filters-form">
        <div class="filters-row">
          <mat-form-field appearance="outline">
            <mat-label>Código Fox</mat-label>
            <input matInput formControlName="codigo" placeholder="Ej: ALG001" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Nombre del Material</mat-label>
            <input
              matInput
              formControlName="nombre"
              placeholder="Ej: Algodón"
            />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Almacén</mat-label>
            <mat-select formControlName="almacen">
              <mat-option value="">Todos los almacenes</mat-option>
              <mat-option
                *ngFor="let almacen of almacenes"
                [value]="almacen.id_almacen.toString()"
              >
                {{ almacen.nombre }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Clase</mat-label>
            <mat-select formControlName="clase">
              <mat-option value="">Todas las clases</mat-option>
              <mat-option
                *ngFor="let clase of clases"
                [value]="clase.id_clase.toString()"
              >
                {{ clase.nombre }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="filters-row">
          <mat-form-field appearance="outline">
            <mat-label>Estado de Stock</mat-label>
            <mat-select formControlName="estado_stock">
              <mat-option value="">Todos los estados</mat-option>
              <mat-option value="CRITICO">Crítico</mat-option>
              <mat-option value="BAJO">Bajo</mat-option>
              <mat-option value="NORMAL">Normal</mat-option>
              <mat-option value="ALTO">Alto</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Stock Mínimo</mat-label>
            <input
              matInput
              type="number"
              formControlName="stock_minimo"
              placeholder="0"
            />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Stock Máximo</mat-label>
            <input
              matInput
              type="number"
              formControlName="stock_maximo"
              placeholder="0"
            />
          </mat-form-field>

          <div class="filter-actions">
            <button
              mat-raised-button
              color="primary"
              (click)="buscar()"
              class="btn-buscar"
            >
              Buscar
            </button>

            <button
              mat-stroked-button
              color="accent"
              (click)="limpiarFiltros()"
              class="btn-limpiar"
            >
              Limpiar
            </button>
          </div>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Tabla de stock -->
  <mat-card class="table-card">
    <mat-card-header>
      <mat-card-title>Stock de Materiales</mat-card-title>
      <mat-card-subtitle>
        Mostrando {{ stocksFiltrados.length }} de {{ stocks.length }} registros
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="table-container">
        <table mat-table [dataSource]="stocksFiltrados" class="stock-table">
          <!-- Columna Código -->
          <ng-container matColumnDef="codigo">
            <th mat-header-cell *matHeaderCellDef>Código Fox</th>
            <td mat-cell *matCellDef="let stock">
              <span class="codigo-cell"
                >{{ formatearCodigo(stock.codigo_fox) }}</span
              >
            </td>
          </ng-container>

          <!-- Columna Material -->
          <ng-container matColumnDef="material">
            <th mat-header-cell *matHeaderCellDef>Material</th>
            <td mat-cell *matCellDef="let stock">
              <div class="material-cell">
                <div class="material-name">{{ stock.nombre }}</div>
                <div class="material-unit">{{ stock.unidad }}</div>
              </div>
            </td>
          </ng-container>

          <!-- Columna Almacén -->
          <ng-container matColumnDef="almacen">
            <th mat-header-cell *matHeaderCellDef>Almacén</th>
            <td mat-cell *matCellDef="let stock">
              <span class="almacen-cell">{{ stock.almacen }}</span>
            </td>
          </ng-container>

          <!-- Columna Clase -->
          <ng-container matColumnDef="clase">
            <th mat-header-cell *matHeaderCellDef>Clase</th>
            <td mat-cell *matCellDef="let stock">
              <span class="clase-cell">{{ stock.clase }}</span>
            </td>
          </ng-container>

          <!-- Columna Stock Actual -->
          <ng-container matColumnDef="stock_actual">
            <th mat-header-cell *matHeaderCellDef>Stock Actual</th>
            <td mat-cell *matCellDef="let stock">
              <div class="stock-cell">
                <div class="stock-value">
                  {{ formatearNumero(stock.stock_actual) }}
                </div>
                <div class="stock-limits">
                  Min: {{ formatearNumero(stock.stock_minimo) }} | Max: {{
                  formatearNumero(stock.stock_maximo) }}
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Columna Estado -->
          <ng-container matColumnDef="estado">
            <th mat-header-cell *matHeaderCellDef>Estado</th>
            <td mat-cell *matCellDef="let stock">
              <div
                class="estado-chip"
                [class]="getColorEstado(stock.estado_stock)"
              >
                {{ stock.estado_stock }}
              </div>
            </td>
          </ng-container>

          <!-- Columna Valor Total -->
          <ng-container matColumnDef="valor_total">
            <th mat-header-cell *matHeaderCellDef>Valor Total</th>
            <td mat-cell *matCellDef="let stock">
              <div class="valor-cell">
                <div class="valor-total">
                  {{ formatearMoneda(stock.valor_total) }}
                </div>
                <div class="costo-unitario">
                  {{ formatearMoneda(stock.costo_unitario) }} / {{ stock.unidad
                  }}
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Columna Último Movimiento -->
          <ng-container matColumnDef="ultimo_movimiento">
            <th mat-header-cell *matHeaderCellDef>Último Movimiento</th>
            <td mat-cell *matCellDef="let stock">
              <div class="movimiento-cell">
                <div class="fecha">
                  {{ formatearFecha(stock.fecha_ultimo_movimiento) }}
                </div>
                <button
                  mat-icon-button
                  color="primary"
                  (click)="verMovimientos(stock)"
                  matTooltip="Ver historial de movimientos"
                >
                  <mat-icon>history</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>

        <!-- Mensaje cuando no hay datos -->
        <div *ngIf="stocksFiltrados.length === 0" class="no-data">
          <h3>No se encontraron registros de stock</h3>
          <p>Ajuste los filtros de búsqueda para obtener resultados</p>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
